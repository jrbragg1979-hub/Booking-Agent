var webhookData = $("Vapi Tool Webhook").first().json;
var body = webhookData.body || webhookData;
var message = body.message || body;
var toolCall = message.toolCallList[0];
var toolCallId = toolCall.id;
var address = toolCall.arguments.address || "";
if (!address) {
  return [{ json: { results: [{ toolCallId: toolCallId, result: JSON.stringify({ valid: false, suggestion: "No address provided. Ask the caller for their full address." }) }] } }];
}
var apiKey = "GOOGLE_API_KEY_HERE";
var url = "https://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(address) + "&key=" + apiKey;
var response = await fetch(url);
var data = await response.json();
if (data.status !== "OK" || data.results.length === 0) {
  return [{ json: { results: [{ toolCallId: toolCallId, result: JSON.stringify({ valid: false, suggestion: "Could not validate this address. Please ask the caller to repeat their full address including city and zip code." }) }] } }];
}
var result = data.results[0];
var formatted = result.formatted_address;
var components = result.address_components;
var county = "";
for (var i = 0; i < components.length; i++) {
  var types = components[i].types;
  for (var j = 0; j < types.length; j++) {
    if (types[j] === "administrative_area_level_2") {
      county = components[i].long_name;
    }
  }
}
var inServiceArea = county === "Sonoma County" || county === "Marin County";
if (inServiceArea) {
  return [{ json: { results: [{ toolCallId: toolCallId, result: JSON.stringify({ valid: true, formattedAddress: formatted, county: county, suggestion: "Validated address: " + formatted }) }] } }];
} else {
  return [{ json: { results: [{ toolCallId: toolCallId, result: JSON.stringify({ valid: false, formattedAddress: formatted, county: county, suggestion: "This address is in " + county + ", which is outside our service area (Sonoma and Marin County). Let the caller know we may not be able to service that location." }) }] } }];
}
